* 计算机网络体系结构中的**物理层**、**数据链路层**、以及**网络层**它们共同解决了主机将通过异构网络互联起来所面临的问题，*实现了主机到主机的通信*
* 但实际上在计算机网络中进行**通信的真正实体是位于通信两端主机中的进程**
* 运输层的任务是给运行在不同主机上的应用进程提供直接的通信服务，运输层协议又称为端到端协议
* 运输层向高层用户屏蔽了下面网络核心的细节（网络拓扑、路由选择协议等），它使应用进程看见的就好像是在两个运输层实体之间有一条端到端的逻辑通信信道
* 运输层提供两种运输协议，即*面向连接的TCP*和*无连接的UDP*

### 运输层中端口号、复用和分用的概念
* 运输层端口号是指在计算机网络中，用于标识应用程序或服务的端口号。每个端口号都与一个特定的应用程序或服务相关联。如HTTP服务使用的端口号是80，FTP服务使用的端口号是21
* 复用（Multiplexing）是指在发送端将多个应用程序的数据流合并成一个数据流进行传输，而在接收端将这个数据流分解成多个应用程序的数据流。这样可以节省网络资源，提高网络的利用率。在TCP/IP协议中，复用是通过端口号来实现的。发送端将数据包发送到目的地址的相应端口号，接收端根据端口号将数据包分发给对应的应用程序。
* 分用（Demultiplexing）是指在接收端将一个数据流分解成多个应用程序的数据流。接收端根据端口号将接收到的数据包分发给对应的应用程序。在TCP/IP协议中，分用是通过端口号来实现的。接收端根据端口号将接收到的数据包分发给对应的应用程序。

### UDP和TCP的对比

用户数据报协议UDP（User DATa gram Protocol）
* 无连接
* 支持一对一，一对多，多对一和多对多交互通信
* 对应用层交付的报文直接打包
* 尽最大努力交付，也就是不可靠；不使用流量控制和拥塞控制
* 首部开销小，仅8字节

传输控制协议TCP（Transmission Control Protocol）
* 面向连接
* 每一条TCP连接只能有两个端点，只能是一对一通信
* 可靠传输，使用流量控制和拥塞控制
* 首部最小20字节，最大60字节

#### TCP的流量控制
* 一般来说，我们是希望数据传输的更快一些
   * 但如果发送方把数据发送得过快，接收方就可能来不及，这就会造成数据的丢失
* 所谓流量控制（flow control）就是**让发送方的发送速率不要太快，要让接收方来得及接收**
* 利用滑动窗口机制，可以很方便地在TCP连接数实现对放松方地流量控制
   * TCP接收方利用自己的**接收窗口**大小来限制发送方**发送窗口**的大小
   * TCP发送方收到接收方的**零窗口通知**后，应启动**持续计时器**。持续计时器超时后，向接收方发送**零窗口探测报文**

#### TCP的拥塞控制

TCP拥塞控制是一种网络流量控制机制，旨在避免网络拥塞并保证数据传输的可靠性。TCP拥塞控制包括四个主要算法：慢开始、拥塞避免、快重传和快恢复
1. 慢开始（Slow Start）：慢开始算法的主要目的是在数据传输开始时缓慢增加发送方的拥塞窗口（cwnd），以避免网络拥塞。发送方在开始传输数据时，将拥塞窗口设置为一个较小的值，然后每收到一个确认消息就将拥塞窗口增加一倍，直到达到一个阈值（通常是拥塞窗口的一半）。这个阈值称为慢开始阈值（ssthresh）
2. 拥塞避免（Congestion Avoidance）：拥塞避免算法的主要目的是在网络拥塞时减少发送方的拥塞窗口，以避免网络拥塞的进一步恶化。发送方在达到慢开始阈值后，将拥塞窗口增加一个拥塞窗口的倒数（即每个确认消息增加1/cwnd），这样就可以缓慢增加发送方的拥塞窗口，避免网络拥塞
3. 快重传（Fast Retransmit）：快重传算法的主要目的是在网络丢包时快速重传丢失的数据包，以减少数据传输的延迟。如果发送方连续收到三个重复的确认消息，就会认为有一个数据包丢失了，并立即重传该数据包，而不必等待超时
4. 快恢复（Fast Recovery）：快恢复算法的主要目的是在网络丢包时快速恢复发送方的拥塞窗口，以减少数据传输的延迟。如果发送方连续收到三个重复的确认消息，就会认为有一个数据包丢失了，并将拥塞窗口设置为慢开始阈值的一半，然后进入快恢复状态。在快恢复状态下，发送方每收到一个确认消息就将拥塞窗口增加1，直到达到慢开始阈值


#### TCP可靠传输实现

* TCP基于以字节为单位的滑动窗口来实现可靠传输
   * 发送方在未收到接收方的确认时，可将发送窗口内还未发送的数据全部发送出去
   * 接收方只接收序号落入发送窗口内的数据
* 虽然发送方的发送窗口是根据接收方的接收窗口设置的，但在同一时刻，**发送方的发送窗口并不总是和接收方的接收窗口**一样大
   * 网络传送窗口值需要经历一定的时间滞后，并且这个时间不确定
   * 发送方还可能根据网络当时的拥塞情况适当减小自己的发送窗口尺寸
* 对于**不按序到达数据应如何处理，TCP无明确规定**
   * 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理系那个会比较简单，但这样对网络资源利用不好，因为发送方会重复传送较多的数据
   * TCP通常对不按序到达的数据是先临时存在接收窗口上，等到字节流中所缺少的字节收到后，再**按序交付上层的应用进程**
* TCP要求接收方必须要有**累积确认**和**捎带确认**机制，这样可以减小传输开销。接收方可以再合适的时候发送确认，也可以再字节有数据要发送时把确认信息顺便捎带上
   * 接收方不应过分推迟发送确认，否则会导致发送方不必要的超时重传
   * 捎带确认实际上并不经常发生，因为大多数应用程序很少同时再两个方向上发送数据
* **TCP的通信是全双工通信**通信中的每一方都在发送和接收报文段。因此，每一方都有自己的发送窗口和接收窗口


#### TCP的运输连接管理——TCP的连接建立

* TCP是面向连接的协议，它基于运输连接来传送TCP报文段
* TCP运输连接的建立和释放是每一次面向连接的通信中必不可少的过程
* TCP运输连接有三个阶段：
   * 建立TCP连接
   * 数据传送
   * 释放TCP连接
![](img/09.png)

三次握手是TCP协议中建立可靠连接的过程，它由客户端和服务器之间的三个步骤组成。这三个步骤分别是：
1. 第一次握手：客户端向服务器发送一个SYN（同步）数据包，其中包含一个随机生成的序列号（Seq）
2. 第二次握手：服务器收到客户端的SYN数据包后，向客户端回复一个SYN+ACK（同步、确认）数据包，其中包含确认号（ack）和一个随机生成的序列号（Seq）
3. 第三次握手：客户端收到服务器的SYN+ACK数据包后，向服务器回复一个ACK（确认）数据包，其中包含确认号（ack），此时TCP连接已经建立
三次握手的目的是确保客户端和服务器之间的TCP连接是可靠的，防止重复连接和数据包丢失等问题。通过这个过程，客户端和服务器之间可以互相确认彼此的身份，并建立起一个可靠的连接来传输数据
![](img/10.png)


#### TCP的运输连接管理——TCP的连接释放

四次挥手是TCP连接的断开过程，由客户端和服务器共同完成。四次挥手的过程如下：
1. 客户端发送一个FIN报文给服务器，表示客户端已经没有数据要发送了
2. 服务器接收到FIN报文后，发送一个ACK报文给客户端，表示服务器已经接收到了客户端的FIN报文
3. 服务器发送一个FIN报文给客户端，表示服务器已经没有数据要发送了
4. 客户端接收到服务器的FIN报文后，发送一个ACK报文给服务器，表示客户端已经接收到了服务器的FIN报文
这样四次挥手过程完成后，TCP连接就被正常地关闭了。需要注意的是，四次挥手过程中，每个报文都需要对方发送确认，因此需要四次挥手才能完成连接的断开

![](img/11.png)