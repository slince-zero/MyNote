网络层的主要任务是**实现网络互连**，进而实现**数据包在各个网络之间的传输**
网络层解决的主要问题：
   * 网络层向运输层提供怎样的服务（可靠、不可靠传输）
   * 网络层寻址问题
   * 路由选择问题

### 网络层提供的两种服务

对比方面|虚电路服务|数据报服务
:--|:--:|:--:
思路|可靠通信应当由网络来保证|可靠通信由用户主机来保证
连接的建立|必须建立网络层连接|不需要建立网络层连接
终点地址|仅在连接建立阶段使用，每个分组使用短的虚电路号|每个分组都有终点的完整地址
分组的转发|属于同一条虚电路的分组均按照同一路由进行转发|每个分组可走不同的路由
当结点出故障时|所有通过出故障的结点的虚电路均不能工作|出故障的结点可能会丢失分组，一些路由可能会发生变化
分组的顺序|总是按发送顺序到达终点|到达终点时不一定按发送顺序
服务质量保证|可以将通信资源提前分配给每一个虚电路，容易实现|很难实现


### IPv4地址概述

**IPv4地址**就是，给因特网上的每一台主机（或路由器）的每一个接口分配一个，在全世界范围内是**唯一的32比特的标识符**
IPv4地址的编址方法经历了三个阶段：分类编址---划分子网---无分类编址
IPv4地址采用**点分十进制表示方法**

#### 分类编址的IPv4地址

![](img/07.png)

#### 划分子网的IPv4地址

* 为新增网络申请新的网络号会带来很多弊端：
   * 需要等待时间和花费更多的费用
   * 会增加其他路由器中路由表记录的数量
   * 浪费原有网络号中剩余的大量IP地址
* 可以从主机号借用一部分比特作为子网号
* **32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号**
   * 子网掩码使用**连续的比特1来对应网络号和子网号**
   * 子网掩码使用**连续的比特0来对应主机号**
   * 将划分子网的IPv4地址与其相应的子网掩码进行逻辑与运算就可得到IPv4地址所在子网的网络地址
* 给定一个分类的IP地址和其相应的子网掩码，就可知道子网划分的细节：
   * 划分出的子网数量
   * 每个子网可分配的IP地址数量
   * 每个子网的网络地址和广播地址
   * 每个子网可分配的最小和最大地址
* 默认的子网掩码是指再未划分子网的情况下使用的子网掩码
   * A类：255.0.0.0
   * B类：255.255.0.0
   * C类：255.255.255.0

#### 无分类编址的IPv4地址

* 划分子网在一定程度上缓解了因特网在发展中遇到的困难，但是**数量巨大的C类网**因为其地址空间太小，没有得到充分的使用，而因特网的IP地址仍在加速消耗，整个IPv4地址空间面临全部消耗的威胁
* 因此有了无分类域间路由选择CIDR（Classless Inter-Domain Routing）
   * CIDR取消了传统的A类、B类、C类地址，以及划分子网的概念
   * CIDR可以更加有效的分配IPv4的地址空间
* CIDR使用**斜线记法**，即在IPv4地址后面加上" / "，在斜线后面写上网络前缀所占的比特数量
* CIDR实际上是将网络前缀都相同的连续的IP地址组成一个“CIDR地址块”
* 路由聚合（也称超网）的方法是找共同前缀
* 网络前缀越长，地址块越小，路由越具体
* 若路由器查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条，这称为**最长前缀匹配**，因为这样的路由更具体

### IP数据报的发送和转发过程

#### 主机发送IP数据报

判断目的主机是否与自己在同一个网络：
   * 若在同一个网络，则属于**直接交付**
   * 若不在同一个网络，则属于**间接交付**，传输给主机所在的网络的默认网关（路由器），由默认网关帮忙转发；

#### 路由器转发IP数据报

1. 检查IP数据报首部是否出错：
   * 若出错，则直接丢弃该IP数据报并通告源主机
   * 若没有出错，则进行转发
2. 根据IP数据报的目的地址在路由表中查找匹配的条目：
   * 若找到匹配的条目，则转发给条目中指示的下一跳
   * 若找不到，则丢弃该IP数据报并通告源主机



### 路由选择协议概述

它分为静态和动态路由选择两类

* 静态路由选择
   * 由人工培植的网络路由、默认路由、特定主机路由、黑洞路由等都属于静态路由
   * 这种人工配置方式简单、开销小，但不能及时适应网络状态（流量、拓扑等）的变化
   * 一般只在小规模网络中采用
* 动态路由选择
   * 路由选择器通过路由选择自动获取路由信息
	当一个数据包需要从源设备传输到目的设备时，路由器需要根据路由表中存储的路由信息选择最佳的路径将数据包传输到目的地。路由选择器通过交换路由信息，更新路由表，选择最优路径，从而实现网络中的数据传输。

路由选择器通过交换路由信息的方式，可以自动获取网络中的路由信息，包括网络拓扑结构、路由器之间的连接状态、网络中的子网等信息。它可以将这些信息传递给其他路由器，更新路由表，并根据最新的路由信息选择最佳的路径进行数据转发。
   * 比较复杂，开销大，能较好的适应网路状态的变化
   * 适用于大规模网路

![](img/08.png)


#### 路由信息协议RIP的基本工作原理

* 路由信息协议RIP（Routing Information Protocol）是内部网关协议IGP中最先得到广泛使用的协议之一
* RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为“距离向量”
* RIP使用“跳数”来衡量到达目的网络的距离
   * 路由器到直连网络的距离定义为1
   * 路由器到非直连网络的距离定义为所经过的路由器数目+1
   * 允许一条路径最多只能包含15个路由器，“距离”等于16时，表示不可达。因此，RIP只适用于小型互联网
* RIP认为好的路由就是“距离短”的路由，也就是**所通过路由器数量最少的路由**
* 当到达同一目的网络的网络有多条“距离相等”的路由时，可以进行**等价负载均衡**
* RIP包含以下三个要点：
   * 和谁交换信息 仅和**相邻路由器**交换信息
   * 交换什么信息 **自己的路由表**
   * 何时交换信息 **周期性交换**
* RIP的基本工作过程：
 1. 路由器刚开始工作时，只知道自己到直连网络的距离是1
 2. 每个路由器仅和相邻路由器周期性交换并更新路由信息
 3. 若干次交换和更新后，每个路由器都知道到达本AS内个网络的最短距离和下一跳地址，称为**收敛**
* RIP的路由条目的更新规则*：
  * 发现了新网络，添加
  * 到达目的网络，相同下一跳，最新消息，更新
  * 到达目的网络，不同下一跳，新路由优势，更新
  * 到达目的网络，不同下一跳，新路由劣势，不更新
  * 到达目的网络，不同下一跳，等价负载均衡
* RIP存在“*坏消息传播的慢*”的问题
* 坏消息传播的慢，又称为**路由环路**或**距离无穷计数**问题，这是距离向量算法的一个固有问题
	距离向量算法（Distance Vector Algorithm）是一种用于计算路由器之间最短路径的算法。它是一种分布式算法，每个路由器只知道自己与相邻路由器之间的距离和路径信息，通过交换路由表信息，逐步更新整个网络中的路由表，最终得到每个路由器到其他路由器的最短路径。
	距离向量算法的基本思想是，每个路由器维护一个距离向量表，记录到达网络中每个目的地的距离和路径。路由器通过将自己的距离向量表发送给相邻路由器，接收相邻路由器的距离向量表，并根据收到的信息更新自己的距离向量表。路由器之间周期性地交换距离向量表，直到整个网络的路由表收敛到最优解。
	距离向量算法的优点是实现简单、计算速度快，适用于小型网络。但是它也有一些缺点，比如容易出现路由环路问题、收敛速度慢、路由器需要周期性地更新路由表等。因此，在大型网络中，通常采用链路状态路由算法（Link State Algorithm）来计算最短路径，它可以更准确地计算网络中的路径，并且具有更好的可扩展性和稳定性。