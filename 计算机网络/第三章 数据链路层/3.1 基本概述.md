* 链路（Link）就是从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换节点
* 数据链路（Data Link）是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路
* 数据链路层以**帧**为单位传输和处理数据

使用点对点信道的数据链路层要解决的三个问题：
封装成帧、差错检测、可靠传输

### 封装成帧

* 封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧
   * 帧头和帧尾中包含有重要的控制信息
   * 帧头和帧尾的作用之一就是帧定界
* **透明传输**是指**数据链路层对上层交付的传输数据没有任何限制**，就好像数据链路层不存在一样
   * 面向字节的物理链路使用**字节填充**的方法实现透明传输
   * 面向比特的物理链路使用**比特填充**的方法实现透明传输
* 为了提高帧的传输速率，应当使帧的**数据部分的长度尽可能大一些**
* 考虑到差错控制等多种原因，每一种数据链路层协议都规定了帧的数据部分的长度上限，即**最大传送单元MTU**（Maximum Transfer Unit）
![](img/05.png)

### 差错检测

* 实际的通信链路都是不理想的，比特在传输过程当中可能会产生差错，1可能变为0，0可能变为1，这就是**比特差错**
* 在一段时间内，传输错误的比特所占传输比特总数的比率成为**误码率**BER（Bit Error Rate）
* 于是有两种常用的检测方式：奇偶校验和循环冗余校验CRC（Cyclic Redundancy Check）
##### 奇偶校验
 * 在待发送的数据后面**添加1位奇偶校验位**，使整个数据（包括所添加的校验位在内）中“**1“的个数为奇数**（奇校验）或偶数（偶校验）
 * 如果有**奇数个位发生误码**，则奇偶性**发生**变化，**可以**检查出误码
 * 如果有**偶数个位发生误码**，则奇偶性**不发生**变化，**不能**检查出误码（漏检）
##### 循环冗余校验
  * 收发双方约定好一个**生成多项式**G（x）
  * 发送方基于待发送的数据和生成多项式计算出 差错检验码（**冗余码**），将其添加到待传输的数据后面一起传输
  * 接收方通过生成多项式来计算收到的数据是否产生了误码

##### 注意
   * **检错码**只能检测出帧在传输过程中出现了差错，但不能定位错误，因此**无法纠正错误**
   * 要想纠正传输中的差错，可以使用冗余信息更多的**纠错码**进行**前向纠错**。但纠错码的开销比较大，在计算机网络中**较少**使用
   * 循环冗余校验CRC有很好的检错能力（**漏检率非常低**），虽然计算比较复杂，但非常易于用硬件实现，因此被广泛应用于数据链路层


### 可靠传输

* 使用**差错检测技术**（例如循环冗余CRC），接收方的数据链路层就可检测出帧在传输过程中是否产生了误码（比特错误）
* 数据链路层向上提供的服务类型：
   * **不可靠**传输服务：仅仅丢弃有误码的帧，其他什么也不做
   * **可靠**传输服务：想办法实现**发送端发送什么，接收端就接收什么**
* **无线链路**易受干扰，误码率比较高，因此要求**数据链路层**必须向上层提供**可靠**传输服务

#### 停止-等待协议SW（Stop-and-Wait）

* 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传，但对于误码率较高的点对点链路，为使发送方**尽早重传**，也可给发送放**发送NAK分组**
* 为了让接收方能够判断所收到的数据分组是否是重复的，需要给数据**分组编号**。由于停止-等待协议的停止等待特性，因此只需要**1个比特**编号就够了，即编号0和1
* 为了让发送方能够判断所收到的ACK分组是否是重复的，需要给**ACK分组编号**，所用比特数量**与数据分组编号所用比特数量一样**。数据链路层一般不会出现ACK分组迟到的情况，因此在**数据链路层实现停止-等待协议可以不用给ACK分组编号**

#### 回退N帧协议GBN（Go-Back-N）

回退N帧协议在流水线传输的基础上利用发送窗口来限制发送方连续发送数据分组的数量，是一种连续ARQ协议。

在协议的工作过程总发送窗口和接收窗口不断向前滑动，因此这类协议又叫做滑动窗口协议

由于回退N帧协议的特性，当通信线路质量不好的时候，其信道利用率并不比停止-等待协议高

* 接收方地接收窗口尺寸 Wr 的取值范围是 Wr = 1，因此接收方只能按序接收数据分组
* 接收方只接收序号落在接收窗口内且无误码的数据分组，并且将接收窗口向前滑动一个位置，与此同时给发送方发回相应的确认分组。为了减少开销，接收方不一定每收到一个按序到达且无误码的数据分组就给发送方发回一个确认分组
   * 而是连续在收到好几个按序到达且无误码的数据分组后（由具体实现决定），才针对最后一个数据分组发送确认分组，这称为累积确认
   * 或者可以在字节有数据分组要发送时才对之前按序接收且无误码的数据分组进行捎带确认
* 接收方收到未按序到达的数据分组，除丢弃外，还要对最近按序接收的数据分组进行确认

#### 选择重传协议SR（Selective Request）

* 接收窗口尺寸Wr的取值范围是 1< Wr <= Wt
* 接收方可接收未按序到达但没有误码并且序号落在接收窗口内的数据分组
   * 为了使发送方仅重传出现差错的分组，接收方不能再采用累积确认，而需要对每个正确接收到的数据分组再逐一确认
* 接收方只有在按序接收数据分组之后，接收窗口才能向前相应滑动


### 点对点协议PPP

* PPP协议为在点对点链路传输各种协议数据报提供了一个标准方法，主要由以下三个部分构成：
   * 对各种协议数据报的封装方法（封装成帧）
   * 链路控制协议LCP ，用于建立、配置以及测试数据链路的连接
   * 一套网络控制协议NCPs ，其中的每一个协议支持不同的网络层协议
* PPP帧的透明传输
   * 面向字节的异步链路使用字节填充法（插入转义字符）
   * 面向比特的同步链路使用的比特填充（零比特填充）
* PPP协议的工作状态


### 媒体接入控制的基本概念

共享信道要着重考虑的一个问题就是如何协调多个发送和接收站点对一个共享传输媒体的占用，即**媒体接入控制MAC**（Medium Access Control）

媒体介入控制分为：
* 静态划分信道
   * 频分多址
   * 时分多址
   * 码分多址
* 动态接入控制
   * 受控接入
   * 随机接入

#### 媒体接入控制——动态接入——随机接入——载波监听多址接入\碰撞检测CSMA/CD协议

* CSMA/CD协议地工作原理：
   * 多点接入MA：多个主机连接在一条总线上，竞争使用总线
   * 载波监听CS：发送帧前线检测总线，若总线空闲96比特时间，则立即发送；若总线忙，则持续检测总线直到总线空闲96比特时间后再重新发送
   * 碰撞检测到CD：边发送边检测碰撞，若检测到碰撞，则立即停止发送，退避一段随机时间后再重新发送
* 使用CSMA/CD协议地以太网地争用期（碰撞窗口）
   * 发送帧地主机最多经过以太网端到端往返传播时延2ε这么长时间，就可检测到本次传输是否发生了碰撞，2ε称为争用期
   * 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞
   * 以太网规定2ε的取值为512比特时间（即发送512比特所耗费的时间）
* 使用CSMA/CD协议的以太网的最小帧长和最大帧长
   * 最小帧长 = 争用期 * 信道带宽（数据发送速率）
   * 以太网的最小帧长确保了主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞，如果检测到碰撞，则停止发送帧的剩余部分，退避一段随机时间后，重新发送该帧
   * 为了防止主机长时间占用总线，以太网的帧也不能太长
![](img/06.png)

CSMA/CD协议曾经用于各种总线结构以太网和双绞线以太网的早期版本中，现在的以太网基于交换机和全双工连接，不会有碰撞，因此没必要使用CSMA/CD协议


#### 媒体接入控制——动态接入——随机接入——载波监听多址接入\碰撞避免CSMA/CA协议
* 802.11 无线局域网在MAC层使用CSMA/CA协议，以尽量减少碰撞发送的概率。不能使用CSMA/CD协议的原因是在无线局域网种无法实现碰撞检测。在使用CSMA/CA协议的同时，还使用停止-等待协议来实现可靠传输
* 为了尽可能地避免各种可能地碰撞，CSMA/CA协议采用了一种不同于CSMA/CD协议地退避算法。当要发送帧地站点检测到信道从忙态转为空闲时，都要执行退避算法
* 802.11 标准规定，所有站在完成发送后，必须再等待一段帧间间隔时间才能发送下一帧。帧间间隔地长短取决于该站要发送地帧地优先级
* 在802.11 无线局域网地MAC帧首部种有一个持续字段，用来填入在本帧结束后还要占用信道多少时间，其他站点通过该字段可实现虚拟载波监听
* 802.11 标准允许要发送数据地站点对信道进行预约，即在发送数据帧之前先发送，请求发送RTS帧，在收到响应允许发送CTS帧后，就可发送数据帧


### MAC地址、IP地址以及ARP协议

MAC地址是以太网地MAC子层所使用地地址----数据链路层
IP协议是属于TCP/IP体系结构网际层所使用地地址---网际层
ARP协议属于TCP/IP体系结构地网际层，其作用是已知设备所分配到地IP地址，使用ARP协议可以通过IP地址获取到设备的MAC地址----网际层

#### MAC地址
* 当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个数据链路层地址
* 在每个主机发送的**帧中必须携带标识发送主机和接收主机的地址**。由于这类地址是用于媒体接入控制MAC（Media Access Control），因此这类地址被称为MAC地址
   * MAC地址一般被固化在网卡（网络适配器）的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为**硬件地址**
   * MAC地址有时候也被称为**物理地址**（注意：*这并不意味着MAC地址属于网络体系结构中的物理层*）
* 一般情况下，用户主机会包含两个网络适配器：有线局域网适配器（有线网卡）和无线局域网适配器（无线网卡）。每个网络适配器都有一个全球唯一的MAC地址，而交换机和路由器往往拥有更多的网络接口，所以会拥有更多的MAC地址。因此，**严格来说，MAC地址是对网络上各种接口的唯一标识，而不是对网络上各设备的唯一标识**

#### IP地址（本身属于网络层，此处只介绍作用）

* IP地址是因特网（Internet）上的主机和路由器所使用的地址，用于标识两部分信息：
   * 网络编号：标识因特网上数以百万计的网络
   * 主机编号：标识同一网络上不同主机（或路由器）
* MAC地址不具备区分不同网络的功能
   * 如果只是一个单独的网络，不需要接入因特网，可以只使用MAC地址（不是一般用户的应用方式）
   * 如果主机所在的网络要接入因特网，即IP地址和MAC地址都要使用
* 数据包转发过程中IP地址与MAC地址的变化情况：
   * 源IP地址和目的IP地址保持不变
   * 源MAC地址和目的MAC地址逐个链路（或逐个网络）改变

#### 地址解析协议ARP

* 源主机在自己的**ARP高速缓存表**中查找目的主机的IP地址所对应的MAC地址，若找到了，则可以封装MAC帧进行发送；若找不到，则发送**ARP请求（封装在单播MAC帧中）**，ARP响应中包含有目的IP和MAC地址
* 源主机收到ARP响应后，将目的主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后就可以封装之前想发送的MAC帧并发送给目的主机
* ARP的作用范围：**逐段链路或逐个网络使用**
* 除ARP请求和响应外，ARP还有其他类型的报文
* ARP没有安全验证机制，存在**ARP欺骗（攻击）问题**
